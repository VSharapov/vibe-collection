--- draft2.sh	2026-02-05 16:57:37.319792373 -0500
+++ draft3.sh	2026-02-05 17:16:35.274417671 -0500
@@ -10,6 +10,7 @@
 FDD_BENCH_SRC_SIZE_MIB="${FDD_BENCH_SRC_SIZE_MIB:-1024}"
 FDD_BENCH_ROUNDS="${FDD_BENCH_ROUNDS:-8}"
 FDD_BENCH_FIND_MAXDEPTH="${FDD_BENCH_FIND_MAXDEPTH:-4}"
+FDD_BENCH_STABLE_THRESHOLD="${FDD_BENCH_STABLE_THRESHOLD:-0.05}"
 
 # ---------------------------------------------------------------------------
 # Plumbing
@@ -54,10 +55,17 @@
 }
 
 drop-caches() {
-  echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null
+  if [[ $EUID -eq 0 ]]; then
+    echo 3 > /proc/sys/vm/drop_caches
+  else
+    sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches'
+  fi
 }
 
 ensure-sudo() {
+  if [[ $EUID -eq 0 ]]; then
+    return
+  fi
   if ! sudo -n true 2>/dev/null; then
     >&2 echo "Need sudo for drop-caches. Authenticating now..."
     sudo true
@@ -131,6 +139,7 @@
   init [SIZE_MIB]                  Generate random source file (prints path)
   drop-caches                      Drop page cache (needs sudo)
   ensure-sudo                      Pre-authenticate sudo
+  detect-finished                  Read speeds from stdin, detect if stabilized
   timed-write SRC OFF DEST CHUNK ROUND   One write round (prints TSV line)
   timed-read  SRC OFF CHUNK ROUND        One read round (prints TSV line)
   clean MOUNTPOINT                 Remove benchmark artifacts
@@ -140,6 +149,8 @@
   FDD_BENCH_CHUNK_MIB=128          Chunk size per round in MiB
   FDD_BENCH_SRC_SIZE_MIB=1024      Random source file size in MiB
   FDD_BENCH_FIND_MAXDEPTH=4        Max directory depth for find-big-file
+  FDD_BENCH_STABLE_THRESHOLD=0.05  Max relative drop to consider stable (5%)
+  FDD_BENCH_PLOT_TITLE=...         Override plot title
 
 Example:
   $ ./fdd-bench.sh find-big-file /media/vasiliy/Ventoy
@@ -150,13 +161,15 @@
 EOF
 }
 
-detect-plateau() {
-  # Reads a list of numbers from stdin, one per line.
-  # Compares the average of the first half to the average of the second half.
-  # If the second half is <=80% of the first half, reports a plateau at the
-  # second-half average. Otherwise reports "no plateau detected".
-  # Prints the result to stdout.
-  awk '
+detect-finished() {
+  # Reads a list of speed values from stdin (one per line).
+  # Compares the average of the first half to the second half.
+  # "Finished" (stabilized) means:
+  #   - Second half avg >= first half avg (recovered/improving), OR
+  #   - Second half avg dropped by less than FDD_BENCH_STABLE_THRESHOLD (default 0.5%)
+  # "Not finished" means speeds are still declining significantly.
+  local threshold="$FDD_BENCH_STABLE_THRESHOLD"
+  awk -v thresh="$threshold" '
     { vals[NR] = $1; n = NR }
     END {
       if (n < 4) { printf "too few data points\n"; exit }
@@ -166,15 +179,24 @@
       for (i = mid + 1; i <= n; i++) sum2 += vals[i]
       avg1 = sum1 / mid
       avg2 = sum2 / (n - mid)
-      if (avg2 <= avg1 * 0.8) {
-        printf "plateau detected at %.1f MB/s (dropped from %.1f MB/s)\n", avg2, avg1
+      if (avg1 == 0) { printf "stabilized at %.1f MB/s\n", avg2; exit }
+      drop = (avg1 - avg2) / avg1
+      if (drop <= 0) {
+        printf "stabilized at %.1f MB/s (recovered from %.1f MB/s)\n", avg2, avg1
+      } else if (drop <= thresh) {
+        printf "stabilized at %.1f MB/s\n", avg2
       } else {
-        printf "no plateau detected (avg %.1f MB/s)\n", (sum1 + sum2) / n
+        printf "still declining: %.1f -> %.1f MB/s (%.1f%% drop)\n", avg1, avg2, drop * 100
       }
     }
   '
 }
 
+_ts() {
+  # Timestamp prefix for stderr log lines
+  date +%H:%M:%S
+}
+
 full-bench() {
   local mountpoint="$1"
   local rounds="$FDD_BENCH_ROUNDS"
@@ -192,11 +214,11 @@
   local bigfile_path="$mountpoint/$bigfile_rel"
   local bigfile_size_mib
   bigfile_size_mib=$(file-size-mib "$bigfile_path")
-  >&2 echo "[$label] Read source: $bigfile_rel (${bigfile_size_mib} MiB)"
+  >&2 printf "[%s] [%s] Read source: %s (%d MiB)\n" "$(_ts)" "$label" "$bigfile_rel" "$bigfile_size_mib"
 
   # Sanity check
   if (( bigfile_size_mib < chunk )); then
-    >&2 echo "ERROR: Big file (${bigfile_size_mib} MiB) is smaller than chunk size (${chunk} MiB)"
+    >&2 printf "[%s] ERROR: Big file (%d MiB) < chunk size (%d MiB)\n" "$(_ts)" "$bigfile_size_mib" "$chunk"
     exit 1
   fi
 
@@ -204,8 +226,8 @@
   local src_file
   src_file=$(init "$src_size")
   trap "rm -f '$src_file'" EXIT
-  >&2 echo "[$label] Write source: $src_file (${src_size} MiB)"
-  >&2 echo "[$label] Starting $rounds rounds of ${chunk} MiB write/read..."
+  >&2 printf "[%s] [%s] Write source: %s (%d MiB)\n" "$(_ts)" "$label" "$src_file" "$src_size"
+  >&2 printf "[%s] [%s] Starting %d rounds of %d MiB write/read...\n" "$(_ts)" "$label" "$rounds" "$chunk"
   >&2 echo ""
 
   local dest_file="$mountpoint/fdd-bench-output.bin"
@@ -225,8 +247,8 @@
     w_secs=$(echo "$w_line" | cut -f4)
     w_mbps=$(echo "$w_line" | cut -f5)
     write_speeds+=("$w_mbps")
-    >&2 printf "[WRITE %2d/%d]  offset=%4dMiB  %d MiB in %ss  →  %s MB/s\n" \
-      "$i" "$rounds" "$w_offset" "$chunk" "$w_secs" "$w_mbps"
+    >&2 printf "[%s] [WRITE %2d/%d]  offset=%4dMiB  %d MiB in %ss  →  %s MB/s\n" \
+      "$(_ts)" "$i" "$rounds" "$w_offset" "$chunk" "$w_secs" "$w_mbps"
 
     # --- Read round ---
     local r_offset r_line r_secs r_mbps
@@ -236,13 +258,13 @@
     r_secs=$(echo "$r_line" | cut -f4)
     r_mbps=$(echo "$r_line" | cut -f5)
     read_speeds+=("$r_mbps")
-    >&2 printf "[READ  %2d/%d]  offset=%4dMiB  %d MiB in %ss  →  %s MB/s\n" \
-      "$i" "$rounds" "$r_offset" "$chunk" "$r_secs" "$r_mbps"
+    >&2 printf "[%s] [READ  %2d/%d]  offset=%4dMiB  %d MiB in %ss  →  %s MB/s\n" \
+      "$(_ts)" "$i" "$rounds" "$r_offset" "$chunk" "$r_secs" "$r_mbps"
   done
 
   # Summary
   >&2 echo ""
-  >&2 echo "--- $label Summary ---"
+  >&2 printf "[%s] --- %s Summary ---\n" "$(_ts)" "$label"
   >&2 printf "Write: %s\n" "$(printf '%s\n' "${write_speeds[@]}" | awk '
     { s+=$1; if(NR==1||$1<min)min=$1; if($1>max)max=$1; n++ }
     END { printf "avg=%.1f min=%.1f max=%.1f MB/s", s/n, min, max }
@@ -251,8 +273,8 @@
     { s+=$1; if(NR==1||$1<min)min=$1; if($1>max)max=$1; n++ }
     END { printf "avg=%.1f min=%.1f max=%.1f MB/s", s/n, min, max }
   ')"
-  >&2 printf "Write: %s\n" "$(printf '%s\n' "${write_speeds[@]}" | detect-plateau)"
-  >&2 printf "Read:  %s\n" "$(printf '%s\n' "${read_speeds[@]}" | detect-plateau)"
+  >&2 printf "Write: %s\n" "$(printf '%s\n' "${write_speeds[@]}" | detect-finished)"
+  >&2 printf "Read:  %s\n" "$(printf '%s\n' "${read_speeds[@]}" | detect-finished)"
 
   # Cleanup
   rm -f "$src_file"
